---
import Layout from "../layouts/Layout.astro";
import CardConfess from "../components/CardConfess.astro";
import RencentCard from "../components/RencentCard.astro";
import Modal from "../components/Modal.astro";
import { database } from "../lib/firebase";
import { ref, set } from "firebase/database";

// Handle form submissions
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    
    const userId = crypto.randomUUID();
    const name = formData.get('name')?.toString() || 'Anonymous';
    const to = formData.get('to')?.toString() || '';
    const message = formData.get('message')?.toString() || '';
    const songID = formData.get('songID')?.toString() || '';
    const songName = formData.get('songName')?.toString() || '';
    const create_At = new Date().toISOString();
    
    // Call the WriteConfession function
    const data = database;
    set(ref(data, 'users/' + userId), {
      name,
      to,
      message,
      songID,
      songName,
      create_At
    });
    
    return Astro.redirect('/?success=true');
  } catch (error) {
    console.error('Error submitting form:', error);
  }
}

function WriteConfession(userId, name, to, message, songID, create_At){
  const data = database;
  set(ref(data, 'users/' + userId), {
    name,
    to,
    message,
    songID,
    create_At
  });
}
---

<Layout>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-24">
    <div class="text-center">
      <h1 class="text-4xl md:text-6xl text-zinc-100 mb-6 reenie-beanie-regular">
        Share Your <span class="text-violet-400">Feelings with a Song</span>
      </h1>
      <p class="text-xl md:text-2xl text-zinc-300 max-w-3xl mx-auto mb-10">
        Share your thoughts, feelings, and confessions anonymously with the
        world.
      </p>
      <div class="mt-8">
        <Modal client:load />
        <button
          class="border hover:bg-violet-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 m-2"
          ><a href="/explore">Explore Confessions</a></button
        >
      </div>
    </div>
  </div>

  <!-- Recent Confessions Section -->
  <div>
    <h2 class="text-2xl md:text-3xl font-bold text-white mb-8 text-center">
      Recent Confessions
    </h2>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <RencentCard />
    </div>
  </div>

  <!--  Confessions Section -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
    <h2 class="text-2xl md:text-3xl font-bold text-white mb-8 text-center">
      Many people have confessed
    </h2>

    <div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 md:p-8">
      <CardConfess />
    </div>
  </div>

  <!-- Footer -->
  <footer
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-indigo-300/60"
  >
    <p>Â© 2025 Secret Message | Share your thoughts anonymously</p>
  </footer>
</Layout>
